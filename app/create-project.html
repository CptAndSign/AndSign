<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create Project - AndSign</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      doc,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Replace with your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCByZfSQ-eaSJ7rrp8RSqvxkLYMWIQCAOY",
      authDomain: "andsign-a18bf.firebaseapp.com",
      projectId: "andsign-a18bf",
      storageBucket: "andsign-a18bf.firebasestorage.app",
      messagingSenderId: "682561818074",
      appId: "1:682561818074:web:279fcbe5b934d5d1d844e3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();

    // Preloaded list of known users (can be replaced by admin preload or Cloud Function call)
    const knownUsers = [
      { uid: "abc123", email: "alice@example.com", name: "Alice" },
      { uid: "def456", email: "bob@example.com", name: "Bob" },
      { uid: "ghi789", email: "carol@example.com", name: "Carol" },
      { uid: "jkl012", email: "dave@example.com", name: "Dave" }
    ];

    function populateUserOptions(selectEl) {
      knownUsers.forEach(user => {
        const option = document.createElement("option");
        option.value = user.email;
        option.textContent = `${user.name} (${user.email})`;
        selectEl.appendChild(option);
      });
    }

    function addEmailSelect(containerId) {
      const container = document.getElementById(containerId);
      const select = document.createElement("select");
      select.className = "mb-2 p-2 border rounded w-full";
      select.innerHTML = `<option value="">-- Select User --</option>`;
      populateUserOptions(select);
      container.appendChild(select);
    }

    document.addEventListener("DOMContentLoaded", () => {
      ["designers", "checkers", "approvers"].forEach(addEmailSelect);
    });

    async function createProject() {
      const title = document.getElementById("title").value;
      const version = document.getElementById("version").value;

      const createdBy = auth.currentUser?.uid || "unknown";

      const getSelectedEmails = (containerId) => {
        const selects = document.getElementById(containerId).querySelectorAll("select");
        return Array.from(selects)
          .map(s => s.value)
          .filter(email => email !== "");
      };

      const buildRole = (roleName, emailList) => {
        const eligible = emailList.map(email => {
          const user = knownUsers.find(u => u.email === email);
          return {
            uid: user.uid,
            email: user.email,
            name: user.name
          };
        });
        return {
          role: roleName,
          eligible,
          signed: false,
          signedBy: null,
          signedDate: null
        };
      };

      const signatories = [
        buildRole("Designed", getSelectedEmails("designers")),
        buildRole("Checked", getSelectedEmails("checkers")),
        buildRole("Approved", getSelectedEmails("approvers"))
      ];

      const docRef = doc(db, "projects", crypto.randomUUID());
      await setDoc(docRef, {
        title,
        version,
        createdAt: serverTimestamp(),
        createdBy,
        signatories
      });

      alert("Project created successfully!");
    }
  </script>
</head>
<body class="bg-gray-50 text-gray-900 p-6">
  <div class="max-w-2xl mx-auto bg-white shadow rounded-xl p-6">
    <h1 class="text-2xl font-bold mb-4">Create New Project</h1>

    <label class="block mb-2 font-medium">Project Title</label>
    <input id="title" type="text" class="w-full p-2 border rounded mb-4" />

    <label class="block mb-2 font-medium">Version</label>
    <input id="version" type="text" class="w-full p-2 border rounded mb-6" />

    <div class="mb-6">
      <h2 class="text-lg font-semibold mb-2">Designers</h2>
      <div id="designers"></div>
      <button onclick="addEmailSelect('designers')" class="text-blue-600 mt-2 text-sm">+ Add Designer</button>
    </div>

    <div class="mb-6">
      <h2 class="text-lg font-semibold mb-2">Checkers</h2>
      <div id="checkers"></div>
      <button onclick="addEmailSelect('checkers')" class="text-blue-600 mt-2 text-sm">+ Add Checker</button>
    </div>

    <div class="mb-6">
      <h2 class="text-lg font-semibold mb-2">Approvers</h2>
      <div id="approvers"></div>
      <button onclick="addEmailSelect('approvers')" class="text-blue-600 mt-2 text-sm">+ Add Approver</button>
    </div>

    <button onclick="createProject()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
      Create Project
    </button>
  </div>
</body>
</html>
